/*! psdle 4.0.4 (c) RePod, MIT https://github.com/RePod/psdle/blob/master/LICENSE - min - compiled 2021-04-24 */
var repod={};repod.psdle={config:{version:"4.0.4",versionDate:"2021-04-24"},init:function(){console.log(`PSDLE ${this.config.version} ${this.config.versionDate}`),Object.assign(this.config,{root:repod.psdle,userData:{},gameList:[],locale:__NEXT_DATA__.props.appProps.session.userData.locale,gqlHost:__NEXT_DATA__.runtimeConfig.service.gqlBrowser.host,DOMElements:{collectionFilter:".collection-filter.psw-grid-container",filterExportContainer:"psdle-filter-section-export",filterExportSelects:"psdle-filter-export-selects",PSDLEconfigurator:"psdle-configurator"},propCache:[],catalogCache:{},catalogProps:[],catalogDatabase:this.database}),this.config.lang=this.language.getCurrent(this.config),this.css(),this.userData.init(this.config),this.reactisms.init(this.config),this.reactisms.stateChange.callback(this.config)},postInit:async function(config){config.gameList=await this.api.games(config,this.reactisms.getCurrentPage()),this.caches.props(config),this.generate.filters.section(config),config.userData.catalog&&this.api.init(config)},database:{version:1,name:"PSDLECatalogCache",db:{},init:async function(config,callback){await this.persist()&&(config.userData.catalog=!0,config.root.userData.save(config),this.create.db(config,callback))},persist:function(){return!(!navigator.storage||!navigator.storage.persist)&&navigator.storage.persist().then(function(persistent){return persistent})},drop:function(){this.db.close();var dropDatabase=window.indexedDB.deleteDatabase(this.name);dropDatabase.onsuccess=(e=>console.log(e)),dropDatabase.onerror=(e=>console.error(e)),location.reload()},create:{db:function(config,callback){var db=window.indexedDB.open(config.catalogDatabase.name,config.catalogDatabase.version);db.onerror=(e=>console.error(e)),db.onupgradeneeded=function(e){config.catalogDatabase.db=db.result,config.catalogDatabase.create.upgrade(config,e,db.result)},db.onsuccess=function(e){config.catalogDatabase.db=db.result,callback()}},upgrade:function(config,e,db){e.oldVersion>0&&e.oldVersion<config.catalogDatabase.version&&db.deleteObjectStore("cache"),this.objectStore(config,db)},objectStore:function(config,db){(db=db.createObjectStore("cache",{keyPath:"id"})).createIndex("ID","id",{unique:!0}),db.transaction.oncomplete=(e=>console.log(e)),db.transaction.onerror=(e=>console.log(e))}},transact:{get:function(config,type){return config.catalogDatabase.db.transaction("cache",type)},dumpCacheToDB:function(config,callback,backToCache){var db=this.get(config,"readwrite"),store=db.objectStore("cache");for(var[id,json]of(db.oncomplete=function(e){backToCache?config.catalogDatabase.transact.dumpDBToCache(config,callback):callback(e)},db.onerror=(e=>console.log(e)),Object.entries(config.catalogCache)))store.put({id:id,json:json})},dumpDBToCache:function(config,callback){var db=this.get(config),store=db.objectStore("cache"),readOut={};db.oncomplete=(e=>callback(e)),db.onerror=(e=>console.log(e)),store.openCursor().onsuccess=function(event){var cursor=event.target.result;cursor?(readOut[cursor.key]=cursor.value.json,cursor.continue()):config.catalogCache=Object.assign({},readOut)}},getNewIDs:function(config,callback){var games=config.gameList.map(e=>e.entitlementId),db=this.get(config,"readonly"),store=db.objectStore("cache"),readOut=[];db.onerror=(e=>console.log(e)),store.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor)readOut.push(cursor.key),cursor.continue();else{var newIDs=games.filter(e=>readOut.indexOf(e)<0);console.debug("Catalog new IDs:",newIDs),callback(newIDs)}}}}},reactisms:{init:function(config){this.stateChange.newPushState(config)},getCurrentPage:function(config){return(this.stateChange.tracked||location.pathname).replace(/^\//,"")},stateChange:{tracked:"",timer:0,orgPushState:window.history.pushState,newPushState:function(config){!function(config,orgPushState,callback){window.history.pushState=function(){orgPushState.apply(this,arguments),callback.bind(config.root.reactisms.stateChange)(config,arguments)}}(config,this.orgPushState,this.callback)},callback:function(config,args){this.tracked=location.pathname,this.waitForPage(config,config.root.postInit.bind(config.root))},waitForPage:function(config,callback){clearInterval(config.root.reactisms.stateChange.timer),this.timer=setInterval(function(){null!=document.querySelector(config.DOMElements.collectionFilter)?(document.querySelector(".collection-filter-selected").addEventListener("click",function(e){config.root.reactisms.stateChange.callback(config)}),clearInterval(config.root.reactisms.stateChange.timer),callback(config)):console.log('PSDLE casts "Spin Wheels" on',location.href)},125)}}},caches:{regen:function(config,target){},props:function(config){let excludeProps=["__typename","webctas","conceptId"];if(Object.assign(config,{propCache:config.gameList.map(i=>Object.keys(i)).reduce((i,itemKeys)=>itemKeys).concat(["empty","sortedIndex"])}),Object.keys(config.catalogCache).length>0){let customProps=[],catalogProps=Object.entries(config.catalogCache).filter(data=>null!==data[1]).reduce((a,b)=>Object.keys(b[1])).concat(customProps);config.catalogProps=catalogProps,config.propCache=config.propCache.concat(catalogProps)}else{let importedProps=config.userData.exports.map(e=>e.property).filter(e=>config.propCache.indexOf(e)<0);config.catalogProps=importedProps}config.propCache=config.propCache.filter(function(item,i){var dupeCheck=config.propCache.indexOf(item)==i;return dupeCheck||console.warn("Dupe in propCache:",item),dupeCheck}).filter(item=>excludeProps.indexOf(item)<0).sort(),Object.keys(config.catalogCache).length>0&&config.root.exportView.section.refresh(config)}},userData:{key:"PSDLEuserData",defaults:{catalog:!1,exports:[{property:"name",title:"Name"},{property:"platform",title:"Platform"},{property:"sortedIndex",title:"Date (relative)"}]},init:function(config){config.userData=Object.assign({},this.defaults),console.debug(this.load(config))},save:function(config){localStorage.setItem(this.key,JSON.stringify(config.userData)),console.debug("Saved userData:",localStorage.getItem(this.key))},load:function(config){if(!localStorage.hasOwnProperty(this.key))return`${this.key} not found.`;try{var userData=JSON.parse(localStorage.getItem(this.key));return Object.assign(config.userData,userData),userData}catch(e){return console.debug(e),confirm(`PSDLE had an issue loading user data. Would you like to reset it?\n\n${e}`)&&(this.remove(),location.reload()),e}},remove:function(){localStorage.removeItem(this.key)}},generate:{filters:{section:function(config){var psdleLogo=this.button(config,"h4",this.logo(config),["psw-cell","psw-m-b-m","psdle-filter-button"],e=>this.toggleSectionVisibility(config,config.DOMElements.PSDLEconfigurator)),exportButton=(this.button(config,"h4","Sort",["psw-cell","psw-m-b-m","psdle-filter-button","psdle-filter-sort"],e=>console.log(e)),this.button(config,"h4",`${config.lang.labels.exportView} (${config.gameList.length})`,["psw-cell","psw-m-b-m","psdle-filter-button","psdle-filter-export"],e=>this.toggleSectionVisibility(config,config.DOMElements.filterExportContainer))),configSection=this.sectionGroup(config,"div",config.root.generate.config.section(config,this),["psdle","psw-cell","psw-m-b-m","psw-round-m"],config.DOMElements.PSDLEconfigurator,!0),exportSection=this.sectionGroup(config,"div",config.root.exportView.section.generate(config),["psdle","psw-cell","psw-m-b-m","psw-round-m"],config.DOMElements.filterExportContainer,!0);document.querySelector(config.DOMElements.collectionFilter).prepend(psdleLogo,configSection,exportButton,exportSection)},logo:function(config){var logo=document.createElement("div");return logo.classList.add("psdle","psdle-logo"),logo.title=`${config.version} ${config.versionDate}`,logo},toggleSectionVisibility:function(config,id){var el=document.querySelector(`#${id}`);return el.style.display="none"==el.style.display?"":"none",el},sectionGroup:function(config,elem,content,classes,id,hidden){var el=document.createElement(elem);return el.classList.add(...classes),el.appendChild(content),el.id=id,hidden&&(el.style.display="none"),el},button:function(config,elem,content,classes,onclick){var el=document.createElement(elem);return el.classList.add(...classes),el.onclick=onclick,"object"==typeof content?el.appendChild(content):el.textContent=content,el}},config:{section:function(config){var el=document.createElement("div");return el.append(this.buttons(config)),el},buttons:function(config){var el=document.createElement("div");return el.append(this.helpers.rowButton(config,config.lang.labels.website,function(e){window.open("https://repod.github.io/psdle/","_blank")}),this.helpers.rowButton(config,config.lang.labels.deleteData,function(e){config.root.userData.remove(),config.root.database.drop()})),el.append(this.helpers.version(config)),el},helpers:{rowButton:function(config,text,onclick){var el=document.createElement("button");return el.innerText=text,el.onclick=onclick||(e=>console.log(e)),el},version:function(config){let versionLabel=document.createElement("span");return versionLabel.innerText=`${config.version} ${config.versionDate}`,versionLabel}}}},exportView:{section:{generate:function(config){var el=document.createElement("div");return el.append(this.optionPairs(config)),el.append(this.buttons(config)),el},refresh:function(config){let oldSelects=document.querySelector(`#${config.DOMElements.filterExportSelects}`),newSelects=config.root.exportView.section.optionPairs(config);oldSelects.replaceWith(newSelects),config.root.userData.save(config)},buttons:function(config){var el=document.createElement("div");return el.append(this.button(config,"＋",e=>this.addOptionPair(config)),this.button(config,"－",e=>this.removeOptionPair(config)),document.createElement("br"),this.button(config,"Import",e=>config.root.exportView.download.importExports(config)),this.button(config,"JSON",e=>config.root.exportView.download.generate(config,"JSON")),this.button(config,"CSV",e=>config.root.exportView.download.generate(config,"CSV"))),el},button:function(config,text,onclick){var el=document.createElement("button");return el.innerText=text,el.onclick=onclick||(e=>console.log(e)),el},optionPairs:function(config){var el=document.createElement("div");for(var i in el.id=config.DOMElements.filterExportSelects,config.userData.exports){var userProps=config.userData.exports[i];el.append(this.optionPair(config,userProps.title,userProps.property))}return el},optionPair:function(config,textOption,selectOption){var elSpan=document.createElement("span");return elSpan.append(this.textOption(config,textOption),this.selectOption(config,selectOption)),elSpan},addOptionPair:function(config){document.querySelector(`#${config.DOMElements.filterExportSelects}`).append(this.optionPair(config)),config.root.exportView.download.saveExports(config)},removeOptionPair:function(config){var removeTarget=document.querySelectorAll(`#${config.DOMElements.filterExportSelects} span`);removeTarget.length>0&&[...removeTarget].pop().remove(),config.root.exportView.download.saveExports(config)},selectOption:function(config,defaultOption){var el=document.createElement("select");return el.onchange=(e=>this.saveOptions(config,e)),config.propCache.forEach(function(prop){var elOption=document.createElement("option");elOption.value=prop,elOption.text=prop,elOption.selected=prop===defaultOption,el.appendChild(elOption)}),el},textOption:function(config,defaultText){var el=document.createElement("input");return el.onchange=(e=>this.saveOptions(config,e)),el.type="text",el.placeholder=config.lang.labels.exportEmpty,el.defaultValue=defaultText||"",el},saveOptions:function(config){config.root.exportView.download.saveExports(config)}},download:{importExports:function(config){try{var imports=JSON.parse(prompt("",JSON.stringify(config.userData.exports)));imports.map(function(pair){return-1==config.propCache.indexOf(pair.property)&&(console.warn("Bad property?",pair.property),pair.property=config.propCache[0]),pair}),config.userData.exports=imports}catch(e){alert(e)}config.root.exportView.section.refresh(config)},saveExports:function(config){var els=[...document.querySelectorAll(`#${config.DOMElements.filterExportSelects} > span > *`)];return config.userData.exports=els.reduce((t,elem,i,src)=>"SELECT"==elem.nodeName?[...t,{property:elem.value,title:src[i-1].value}]:t,[]),config.root.userData.save(config),config.userData.exports},generate:function(config,download){if(0==Object.keys(config.catalogCache).length){let catalogProps=config.catalogProps;if(catalogProps.length>0&&!confirm(`${config.lang.messages.exportNoProps}\n\n`+catalogProps.join(" ")))return}"CSV"==download&&this.present(config,this.format.csv.build(config,this.format.helpers),".csv"),"JSON"==download&&this.present(config,this.format.json(config,this.format.helpers),".json")},format:{helpers:{sanitize:function(config,itemKeys,userProp,toJSON){switch(userProp){case"sortedIndex":return config.gameList.length-itemKeys.index;case"empty":return"";default:try{var prop=itemKeys[userProp]||config.catalogCache[itemKeys.entitlementId][userProp];return"descriptions"==userProp&&(prop=prop.filter(e=>"LONG"==e.type).pop().value),"price"==userProp&&(prop=config.catalogCache[itemKeys.entitlementId].price.basePrice),"image"==userProp&&(prop=prop.url),"object"==typeof prop&&(prop=toJSON?prop:prop.map(e=>e.type?`${e.type}:${e.value}`:e.value).join(",")),"string"==typeof prop&&((prop=prop.replace(/"/g,'""')).indexOf(",")>-1||prop.indexOf('"')>-1)&&(prop=`"${prop}"`),prop}catch(e){return console.warn(`Couldn't find ${userProp} in ${itemKeys.name} ${itemKeys.entitlementId}`),""}}}},json:function(config,helpers){var temp={version:config.version,columns:config.userData.exports,items:[]};return config.gameList.forEach(function(itemKeys,index){var tempItem={};for(var i in config.userData.exports){var userProp=config.userData.exports[i].property;tempItem[userProp]=helpers.sanitize(config,{...itemKeys,index:index},userProp,!0)}temp.items.push(tempItem)}),JSON.stringify(temp)},csv:{build:function(config,helpers){var temp=[];return temp.push(this.rowSpecial(config,"header")),config.gameList.forEach((itemKeys,index)=>temp.push(this.row(config,itemKeys,index,helpers))),temp.push(this.rowSpecial(config,"footer")),temp.join("\n")},row:function(config,itemKeys,index,helpers){var temp=[];for(var i in config.userData.exports){var userProp=config.userData.exports[i].property;temp.push(helpers.sanitize(config,{...itemKeys,index:index},userProp))}return temp.join(",")},rowSpecial:function(config,type,index){var temp=[];return"header"==type&&(temp=temp.concat(repod.psdle.config.userData.exports.map(prop=>prop.title))),"footer"==type&&(temp=temp.concat(repod.psdle.config.userData.exports.map(prop=>prop.property))).push(`"${JSON.stringify(config.userData.exports).replace(/"/g,"'")}"`,config.version),temp.join(",")}}},present:function(config,content,download){var blob=new Blob(["\ufeff",content],{type:"octet/stream"}),elExport=document.createElement("a");elExport.download=`psdle_${(new Date).toISOString()}${download||"_generic.txt"}`,elExport.href=window.URL.createObjectURL(blob),elExport.dispatchEvent(new MouseEvent("click")),window.URL.revokeObjectURL(blob)}}},api:{process:{cur:0,total:0},init:async function(config){await config.catalogDatabase.persist()?config.catalogDatabase.init(config,()=>this.fetchIDs(config)):this.catalog(config)},fetchIDs:function(config){return!1},games:function(config,currentPage){return this.fetch(config,currentPage).then(r=>r.json()).then(data=>data.data.purchasedTitlesRetrieve.games)},catalog:async function(config,newIDs){var target=newIDs||config.gameList.map(e=>e.entitlementId),process=this.process;if(process.total=target.length,this.queries.catalog.hash=await this.hash(this.queries.catalog.query),0!=target.length)for(let id of target)this.call(config,"catalog",{productId:id}).then(r=>r.json()).then(function(data){process.cur+=1,config.catalogCache[id]=data.errors?null:data.data.productRetrieve;var p=Math.ceil(process.cur/process.total*100);document.querySelector(".psdle-logo").style.background=`var(--psdle-logo-clear), linear-gradient(to right, var(--blue) ${p}%, var(--darker-blue) ${p}%)`,process.cur==process.total&&config.root.api.finish(config)});else this.finish(config)},finish:async function(config){await config.catalogDatabase.persist()?config.catalogDatabase.transact.dumpCacheToDB(config,function(){config.root.caches.props(config)},!0):config.root.caches.props(config)},call:function(config,fetchName,variables){return this.fetch(config,fetchName,variables)},fetch:function(config,fetchName,variables){var gqlRequest=this.buildGQLQuery(config,fetchName,variables),queryParams=Object.entries(gqlRequest).filter(e=>"query"!==e[0]).map(e=>`${e[0]}=`+("object"==typeof e[1]?encodeURIComponent(JSON.stringify(e[1])):e[1])).join("&");return fetch(`${config.gqlHost}/op?${queryParams}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json",Accept:"application/json","x-psn-store-locale-override":config.locale},body:JSON.stringify(gqlRequest)})},buildGQLQuery:function(config,fetchName,variables){var gqlQuery=this.queries[fetchName],gqlRequest={variables:variables&&Object.keys(variables).length>0?variables:gqlQuery.variables,extensions:{persistedQuery:{version:1,sha256Hash:gqlQuery.hash}}};if(gqlQuery.query?gqlRequest.query=gqlQuery.query:gqlRequest.operationName=gqlQuery.operationName,gqlQuery.variables.platform){let platform=document.querySelector(".collection-filter__selected-label span").dataset.trackClick.split(":").pop();gqlQuery.variables.platform="all"==platform?["ps4","ps5"]:[platform]}return gqlRequest},queries:{"recently-purchased":{operationName:"getPurchasedGameList",variables:{isActive:!0,platform:["ps4","ps5"],size:9999,sortBy:"ACTIVE_DATE",sortDirection:"desc",subscriptionService:"NONE"},hash:"00694ada3d374422aa34564e91a0589f23c5f52e0e9a703b19d065dedceb3496"},"ps-plus":{operationName:"getPurchasedGameList",variables:{platform:["ps4","ps5"],size:9999,sortBy:"ACTIVE_DATE",sortDirection:"desc",subscriptionService:"PS_PLUS"},hash:"00694ada3d374422aa34564e91a0589f23c5f52e0e9a703b19d065dedceb3496"},catalog:{query:"query queryRetrieveTelemetryDataPDPProduct($productId: String!) {\n  productRetrieve(productId: $productId) {\n    ... productFragment\n  }\n}\nfragment productFragment on Product {\n  id\n  name\n  publisherName\n  topCategory\n  releaseDate\n  descriptions {\n    type\n    value\n  }\n  compatibilityNotices {\n    type\n    value\n  }\n  media {\n    type\n    url\n    role\n  }\n  edition {\n    name\n  }\n  defaultSku {\n    id\n    name\n    type\n  }\n  skus {\n    id\n  }\n  contentRating {\n    name\n  }\n  localizedStoreDisplayClassification\n  localizedGenres {\n    value\n  }\n  price {\n    basePrice\n    discountedPrice\n    serviceBranding\n  }\n}",variables:"",hash:""}},hash:async function(string){const msgUint8=(new TextEncoder).encode(string),hashBuffer=await crypto.subtle.digest("SHA-256",msgUint8);return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("")}},css:function(){var style=document.createElement("style");style.type="text/css",style.innerHTML='.psdle{--blue:#2185f4;--darker-blue:#063f7e;--bg-hover-filters:#e8e8e8;--psdle-logo-clear:url("data:image/webp;base64,UklGRnIAAABXRUJQVlA4TGUAAAAvU4AHEC9ApG1T/27Hzm6DINum/pwjuMAFBEX/R0OQbTOk+dMM4QYP8H8MbVsBRZEkNXMOAiAACUjAv6wMr3tG9H8Ckn3bhE1lUwEFhE0Nr2LzH4TNGLN5v5VtPgibV5YaT27fVgA=");--thin-padding:8px 16px}.psdle-logo{margin:0 auto;display:block;width:84px;height:31px;background-image:var(--psdle-logo-clear);background-color:var(--blue)}.psdle-filter-button{cursor:pointer}#psdle-configurator button{text-align:left;width:100%;padding:var(--thin-padding);font-weight:400!important;font-size:1rem}#psdle-configurator button:not(:last-child){border-bottom:.0625rem solid #dedede}#psdle-configurator,#psdle-filter-section-export{text-align:center;overflow:hidden;background-color:var(--bg-1)}#psdle-filter-section-export input{cursor:text}#psdle-filter-section-export select{border-style:solid;border:none;background-color:var(--bg-1);border-bottom:.0625rem solid #dedede}#psdle-filter-section-export select option{background-color:#fff}#psdle-filter-section-export input,#psdle-filter-section-export select{width:100%;padding:var(--thin-padding)}#psdle-configurator button:hover,#psdle-filter-section-export input:hover,#psdle-filter-section-export select:hover{background-color:var(--bg-hover-filters)}#psdle-filter-section-export button{padding:.2rem .3rem;margin:.3rem}#psdle-filter-section-export button:hover{color:var(--blue);background-color:var(--bg-hover-filters)}',document.getElementsByTagName("head")[0].appendChild(style)},language:{getCurrent:function(config,override){let outputLang=Object.assign({},this.cache.en.us),locale=(override||config.locale||"en-us").split("-");if(this.cache.hasOwnProperty(locale[0])){let target={};if(this.cache[locale[0]].hasOwnProperty(locale[1]))target=this.cache[locale[0]][locale[1]];else{let def=this.cache[locale[0]].def;console.warn(`${locale[1]} not found for ${locale[0]}, falling back to ${def}`),target=this.cache[locale[0]][def]}Object.assign(outputLang,target)}return outputLang},cache:{en:{def:"us",us:{author:"",local:"English",labels:{exportView:"Export View",exportEmpty:"..?",deleteData:"Delete user data",catalogEnable:"Enable Catalog",website:"Website"},messages:{catalogFirstRun:"Your browser may prompt you for storage permissions. PSDLE will use this to store Catalog responses for quicker and automatic startup.\n\nGranting permission is only required for these benefits.",exportNoProps:"The following properties may not currently exist and could export as nothing, continue?\nThese may require running Catalog first."}}}}}},repod.psdle.init();